<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Hotel Details - HotelFinder</title>
    <link href="/fontawesome-free-6.7.2-web/css/fontawesome.min.css" rel="stylesheet">
    <link href="/fontawesome-free-6.7.2-web/css/all.min.css" rel="stylesheet">
    <link href="/client/style.css" rel="stylesheet">

    <script defer src="/fontawesome-free-6.7.2-web/js/fontawesome.min.js"></script>
    <script defer src="/fontawesome-free-6.7.2-web/js/all.min.js"></script>

    <script src="https://js.stripe.com/basil/stripe.js"></script>
</head>
<body>
<header>
    <!-- Same header as index.html -->
</header>

<div class="container hotel-details-container">
    <!-- Main Hotel Info -->
    <div class="hotel-main">
        <div class="hotel-header">
            <h1 class="hotel-name" id="hotelName"></h1>
            <div class="hotel-rating">
                <span class="hotel-star"><i class="fas fa-star"></i></span>
                <span id="hotelRating"></span>
            </div>
        </div>
        <img alt="Hotel image" class="hotel-main-image" id="hotelImage">
        <p class="hotel-description" id="hotelDescription"></p>
        <div class="hotel-location">
            <i class="fas fa-map-marker-alt"></i>
            <span id="hotelLocation"></span>
        </div>
    </div>

    <!-- Room Types Section -->
    <section class="room-types">
        <h2 class="rooms-title">Available Rooms</h2>
        <div class="room-grid" id="roomGrid"></div>
    </section>

    <!-- Reviews Section -->
    <section class="reviews">
        <h2 class="reviews-title">Guest Reviews</h2>
        <div class="reviews-list" id="reviewsList"></div>
        <form class="hidden" id="reviewForm">
            <textarea placeholder="Write your review..." required></textarea>
            <div class="rating-stars">
                <i class="fas fa-star" data-rating="1"></i>
                <i class="fas fa-star" data-rating="2"></i>
                <i class="fas fa-star" data-rating="3"></i>
                <i class="fas fa-star" data-rating="4"></i>
                <i class="fas fa-star" data-rating="5"></i>
            </div>
            <button class="btn btn-primary" type="submit">Submit Review</button>
        </form>
    </section>

    <!-- FAQ Section -->
    <section class="faqs">
        <h2 class="faqs-title">Frequently Asked Questions</h2>
        <div class="faq-list" id="faqList"></div>
        <form class="hidden" id="faqForm">
            <input placeholder="Enter your question" required type="text">
            <button class="btn btn-primary" type="submit">Ask Question</button>
        </form>
    </section>
</div>

<!-- Payment Modal -->
<div class="modal hidden" id="paymentModal">
    <div class="modal-content">
        <span id="closePaymentModal"><i class="fa-solid fa-times"></i></span>
        <h3>Complete Your Booking</h3>
        <form id="paymentForm">
            <div id="cardElement"></div>
            <button class="btn btn-primary" type="submit">Pay Now</button>
        </form>
    </div>
</div>

<script src="/js/jquery.js"></script>
<script>
    $(document).ready(function () {
        const stripe = Stripe('pk_test_51RQpf6QW2O1tpdCCPDtewogSRFwA5B8AJcFmY7zgZ9tlCEU2WEnW3nAbxt5gwb7icdY116Tf4WiwmDi31tpvVoJ700CnAVXSct');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        let selectedRoomType = null;

        let isLoggedIn = false;
        let currentUser = localStorage.getItem('currentUser');

        // Load hotel data
        const hotelId = window.location.pathname.split('/').pop();

        function initPage() {
            // Load hotel details
            $.get(`/api/hotels/${hotelId}`).done(hotel => {
                $('#hotelName').text(hotel.name);
                $('#hotelRating').text(hotel.rating.toFixed(1));
                $('#hotelImage').attr('src', hotel.image);
                $('#hotelDescription').text(hotel.desc);
                $('#hotelLocation').text(hotel.location);
            });

            // Load room types
            $.get(`/api/roomtype/${hotelId}`).done(rooms => {
                const roomGrid = $('#roomGrid');
                rooms.forEach(room => {
                    roomGrid.append(`
                    <div class="room-card">
                        <img src="${room.image}" alt="${room.label}">
                        <h3>${room.label}</h3>
                        <div class="room-services">
                            ${room.services.map(service => {
                        service = service.toString().split(':')
                        const iconClass = service[1]
                        service = service[0];

                        return `<span class="service-tag"><i class="${iconClass}"></i>  ${service}</span>`
                    }).join('')}
                        </div>
                        <div class="room-price">$${room.price}
                                <span class="price-period">/night</span>
                            </div>
                        <button class="btn btn-primary book-btn" data-room-id="${room.id}">Book Now</button>
                    </div>
                `);
                });
            });

            // Load reviews
            $.get(`/api/reviews/${hotelId}`).done(reviews => {
                const reviewsList = $('#reviewsList');
                reviews.forEach(review => {
                    reviewsList.append(`
                    <div class="review-card">
                        <div class="review-header">
                            <span class="review-author">${review.author}</span>
                            <div class="review-rating">
                                ${Array(Math.floor(review.rating)).fill('<i class="fas fa-star"></i>').join('')}
                            </div>
                        </div>
                        <p class="review-text">${review.text}</p>
                        <span class="review-date">${new Date(review.date).toLocaleDateString()}</span>
                    </div>
                `);
                });
            });

            // Load FAQs
            $.get(`/api/faq/${hotelId}`).done(faqs => {
                const faqList = $('#faqList');
                faqs.forEach(faq => {
                    faqList.append(`
                    <div class="faq-card">
                        <div class="faq-question">${faq.question}</div>
                        <div class="faq-answer">${faq.answer}</div>
                    </div>
                `);
                });
            });
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isLoggedIn = true;
            }
        }

        // Booking handling
        $(document).on('click', '.book-btn', function () {
            // if (!isLoggedIn) {
            //     showLoginModal();
            //     return;
            // }

            selectedRoomType = $(this).data('room-id');
            $('#paymentModal').removeClass('hidden');
            cardElement.mount('#cardElement');
        });

        // Payment form submission
        $('#paymentForm').submit(async (e) => {
            e.preventDefault();
            const {error, paymentMethod} = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement
            });

            if (error) {
                alert(error.message);
            } else {
                $.post(`/api/reservation/${currentUser.id}`, {
                    roomTypeId: selectedRoomType,
                    clientId: currentUser.id
                }).done(() => {
                    alert('Booking successful!');
                    $('#paymentModal').addClass('hidden');
                });
            }
        });

        // Payment closing
        $('#paymentModal').on('hidden.bs.modal', function () {})
        $('#closePaymentModal').on('click', function () {
            $('#paymentModal').addClass('hidden');
        })

        // Review submission
        $('#reviewForm').submit((e) => {
            e.preventDefault();
            const reviewText = $('#reviewForm textarea').val();
            const rating = $('.rating-stars .active').length;

            $.post(`/api/reviews/${hotelId}/${currentUser.id}`, {
                text: reviewText,
                rating: rating
            }).done(() => {
                alert('Review submitted!');
                initPage();
            });
        });

        // FAQ submission
        $('#faqForm').submit((e) => {
            e.preventDefault();
            const question = $('#faqForm input').val();

            $.post(`/api/faq/${hotelId}/${currentUser.id}`, {
                question: question
            }).done(() => {
                alert('Question submitted!');
                initPage();
            });
        });

        // Initialize page
        initPage();
    });
</script>

<style>
    .hotel-details-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 2rem;
    }

    .hotel-main-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 24px;
        margin: 1rem 0;
    }

    .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .room-card {
        background: var(--surface-card);
        padding: 1.5rem;
        border-radius: 24px;
        border: 1px solid var(--glass-border);
    }

    .room-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 16px;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(var(--blur-amount));
    }

    .modal-content {
        background: var(--glass-bg);
        padding: 2rem;
        border-radius: 24px;
        width: 500px;
        margin: 2rem auto;
    }

    #cardElement {
        background: var(--surface-light);
        padding: 1rem;
        border-radius: 16px;
        margin: 1rem 0;
    }

    .review-card, .faq-card {
        background: var(--surface-card);
        padding: 1.5rem;
        margin: 1rem 0;
        border-radius: 16px;
    }

    .rating-stars .fa-star {
        cursor: pointer;
        color: var(--text-light);
        transition: all var(--transition-fast);
    }

    .rating-stars .active,
    .rating-stars .fa-star:hover {
        color: var(--rich-gold);
        transform: scale(1.2);
    }
</style>

</body>
</html>